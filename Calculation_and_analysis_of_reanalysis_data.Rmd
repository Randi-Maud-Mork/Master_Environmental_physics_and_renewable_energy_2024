---
title: "Calculation and analysis of reanalysis data"
author: "Randi Maud Mork"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
### Loading needed packages

```{r}
library(dplyr)
library(lubridate)
library(ggplot2)
library(data.table)
library(tidyr)
library(itertools)
library(cowplot)
library(ggcorrplot)
```

## Creating function for calculation of Convective triggering potential

```{r}
# Integral between the moist adiabatic lapse rate and the actual temperature 
# between 100hPa and 300hPa above ground level


# function for calculation of integrals 

calculate_integral_trapezian_rule <- function(vec, air_pressure){
  areas <- c()
  for (n in c(2:length(vec))){
    area <- ((air_pressure[n-1] - air_pressure[n])/2)*(vec[n]+vec[n-1])
    areas <- append(areas, area)
    
  }
  int <- sum(areas)
  
  return(int)
}


# Defining a fumction to calculate CTP
calculate_CTP<- function(air_temperature, altitude, MALR, air_pressure){
  MALR_temp = air_temperature[1] + (MALR/1000) * (altitude - altitude[1])
  MALR_int <- calculate_integral_trapezian_rule(MALR_temp, air_pressure)
  air_temperature_int <- calculate_integral_trapezian_rule(air_temperature, air_pressure)
  CTP <- MALR_int-air_temperature_int
  # CTP <- sum(MALR-air_temperature)
  
  return(CTP)
}
```

### Creating Functions for MALR

```{r}
######################
# Script to calculate moist adiabatic lapse rate (MALR)


# Pre-calculations needed to calculated MALR
# 1. Calculate saturation vapor pressure
# 2. Calculate saturation mixing ratio
# 3. Calculate dry adiabatic lapse rate
# 4. Calculate moist adiabatic lapse rate


# Function to calculate Saturation Vapor Pressure (e_s)
calculate_saturation_vapor_pressure <- function(temperature) {
  # Constants
  L_v <- 2.5e6  # Latent heat of vaporization (J/kg)
  R_v <- 461    # Gas constant for water vapor (J/(kg*K))
  
  # Calculate saturation vapor pressure
  e_s <- 611 * exp((L_v / (R_v * temperature)) * (1 / 273.15 - 1 / temperature))
  
  return(e_s)
}

##################
# Function to calculate Saturation Mixing Ratio (w_s)
calculate_saturation_mixing_ratio <- function(temperature, pressure) {
  # Constants
  R_d <- 287    # Gas constant for dry air (J/(kg*K))
  
  # Calculate saturation vapor pressure
  e_s <- calculate_saturation_vapor_pressure(temperature)
  
  # Calculate saturation mixing ratio
  w_s <- 0.622 * e_s / (pressure - e_s)
  
  return(w_s)
}


# Function to calculate dry adiabatic lapse rate
calculate_dry_adiabatic_lapse_rate <- function(temperature, pressure) {
  # Constants
  R_d <- 287  # Gas constant for dry air (J/(kg*K))
  
  # Calculate dry adiabatic lapse rate
  gamma_d <- -R_d / (temperature + 273.15)
  
  return(gamma_d)
}

######
# Function to calculate the moist adiabatic lapse rate
calculate_moist_adiabatic_lapse_rate <- function(temperature, pressure, w_s) {
  # Constants
  L_v <- 2.5e6  # Latent heat of vaporization (J/kg)
  c_p <- 1005   # Specific heat of dry air (J/(kg*K))
  R_d <- 287    # Gas constant for dry air (J/(kg*K))
  R_v <- 461    # Gas constant for water vapor (J/(kg*K))
  
  # Calculate moist adiabatic lapse rate
  gamma_d <- calculate_dry_adiabatic_lapse_rate(temperature, pressure)
  gamma_s <- gamma_d * ((1 + w_s * L_v / (R_d * temperature)) / (1 + w_s * L_v^2 / (c_p * R_v * temperature^2)))
  
  return(gamma_s)
}


```

### Creating split datasets and adding MALR and dew point temperature for each

```{r}
# Create split datasets

split_dataset_by_DateTime <- function() {
  ans <- DT[, list(list(.SD)), by=DateTime]$V1
  setattr(ans,'names', unique(DT$DateTime)) 
}

### 2021 ### 

reanalysis_21_data <- read.csv('reanalysis_21.csv')
DT <- as.data.table(reanalysis_21_data)
split_data_21 <- split_dataset_by_DateTime()

data_with_MALR_T_d <- list()
for (n in split_data_21) {
  n <-as.data.frame(n)
  n <-apply(n, 2, rev)
  n <-as.data.frame(n)
  temperature <- n$air_temperature
  pressure <- n$air_pressure
  
  temperature_profile <- n$air_temperature
  pressure_levels <- n$air_pressure
  
  # Calculate saturation mixing ratio using the function
  w_s <- saturation_mixing_ratio <- calculate_saturation_mixing_ratio(temperature_profile, pressure_levels)
  # Calculate MALR
  MALR <- calculate_moist_adiabatic_lapse_rate(temperature,pressure,w_s)
  
   air_temperature <- n$air_temperature
  Relative_humidity <- n$Relative_humidity
  L_v <- 2.5e6    # latent heat of vaporization
  R_v <- 461      # gas constant for vapor

  # Calculate dew_point_temperature
  dew_point_temperature <- air_temperature * (1-((air_temperature*log((Relative_humidity)/100)) / (L_v/R_v)))^(-1)
  
  
  new_rows<- cbind(n,MALR, dew_point_temperature)
  data_with_MALR_T_d <- rbind(data_with_MALR_T_d,new_rows)
  
}

Data_21_with_MALR_T_d <- cbind(DT$DateTime, data_with_MALR_T_d)
DT <- as.data.table(Data_21_with_MALR_T_d)
names(DT)[names(DT) == 'DT$DateTime'] <- 'DateTime'
Reanalysis_data_21_with_MALR <- split_dataset_by_DateTime()



### 2022 ### 

reanalysis_22_data <- read.csv('reanalysis_22.csv')
DT <- as.data.table(reanalysis_22_data)
split_data_22 <- split_dataset_by_DateTime()

data_22_with_MALR <- list()
for (n in split_data_22) {
  n <-as.data.frame(n)
  n <-apply(n, 2, rev)
  n <-as.data.frame(n)
  temperature <- n$air_temperature
  pressure <- n$air_pressure
  
  temperature_profile <- n$air_temperature
  pressure_levels <- n$air_pressure
  
  # Calculate saturation mixing ratio using the function
  w_s <- saturation_mixing_ratio <- calculate_saturation_mixing_ratio(temperature_profile, pressure_levels)
  # Calculate MALR
  MALR <- calculate_moist_adiabatic_lapse_rate(temperature,pressure,w_s)
  
   air_temperature <- n$air_temperature
  Relative_humidity <- n$Relative_humidity
  L_v <- 2.5e6    # latent heat of vaporization
  R_v <- 461      # gas constant for vapor

  # Calculate dew_point_temperature
  dew_point_temperature <- air_temperature * (1-((air_temperature*log((Relative_humidity)/100)) / (L_v/R_v)))^(-1)
  
  
  new_rows<- cbind(n,MALR, dew_point_temperature)
  data_with_MALR_T_d <- rbind(data_with_MALR_T_d,new_rows)
  
}

Data_22_with_MALR_T_d <- cbind(DT$DateTime, data_with_MALR_T_d)
DT <- as.data.table(Data_22_with_MALR_T_d)
names(DT)[names(DT) == 'DT$DateTime'] <- 'DateTime'
Reanalysis_data_22_with_MALR <- split_dataset_by_DateTime()

### 2023 ### 

reanalysis_23_data <- read.csv('reanalysis_23.csv')
DT <- as.data.table(reanalysis_23_data)
split_data_23 <- split_dataset_by_DateTime()

data_with_MALR <- list()
for (n in split_data_23) {
  n <-as.data.frame(n)
  n <-apply(n, 2, rev)
  n <-as.data.frame(n)
  temperature <- n$air_temperature
  pressure <- n$air_pressure
  
  temperature_profile <- n$air_temperature
  pressure_levels <- n$air_pressure
  
  # Calculate saturation mixing ratio using the function
  w_s <- saturation_mixing_ratio <- calculate_saturation_mixing_ratio(temperature_profile, pressure_levels)
  # Calculate MALR
  MALR <- calculate_moist_adiabatic_lapse_rate(temperature,pressure,w_s)

   air_temperature <- n$air_temperature
  Relative_humidity <- n$Relative_humidity
  L_v <- 2.5e6    # latent heat of vaporization
  R_v <- 461      # gas constant for vapor

  # Calculate dew_point_temperature
  dew_point_temperature <- air_temperature * (1-((air_temperature*log((Relative_humidity)/100)) / (L_v/R_v)))^(-1)
  
  
  new_rows<- cbind(n,MALR, dew_point_temperature)
  data_with_MALR_T_d <- rbind(data_with_MALR_T_d,new_rows)
  
}

Data_23_with_MALR_T_d <- cbind(DT$DateTime, data_with_MALR_T_d)
DT <- as.data.table(Data_23_with_MALR_T_d)
names(DT)[names(DT) == 'DT$DateTime'] <- 'DateTime'
Reanalysis_data_23_with_MALR <- split_dataset_by_DateTime()

```


## Implementing CTP in a for loop for all three years

```{r}
### 2021 ###
CTP_21_list_reanalysis <- c()

title_Dates <- names(Reanalysis_data_21_with_MALR)
for(list in as.list(enumerate(Reanalysis_data_21_with_MALR))){
  critical_region <- list$value%>%
    filter(air_pressure < 900, air_pressure > 700)%>%
    mutate(MALR_crit = air_temperature[1] + (MALR/1000) * (geopotential_height - geopotential_height[1]))
 
   CTP <- calculate_CTP(critical_region$air_temperature, critical_region$geopotential_height, critical_region$MALR, critical_region$air_pressure)
  CTP_21_list_reanalysis <- append(CTP_21_list_reanalysis, CTP)
  
}
dates_21 <- ymd_hms(names(Reanalysis_data_21_with_MALR))
CTP_21_reanalysis <- data.frame(Dates = dates_21,
                     CTP = CTP_21_list_reanalysis)

### 2022 ###
CTP_22_list_reanalysis <- c()

for(list in as.list(enumerate(Reanalysis_data_22_with_MALR))){
  critical_region <- list$value%>%
    filter(air_pressure < 900, air_pressure > 700)%>%
    mutate(MALR_crit = air_temperature[1] + (MALR/1000) * (geopotential_height - geopotential_height[1]))
 
   CTP <- calculate_CTP(critical_region$air_temperature, critical_region$geopotential_height, critical_region$MALR, critical_region$air_pressure)
  CTP_22_list_reanalysis <- append(CTP_22_list_reanalysis, CTP)
  
}
dates_22 <- ymd_hms(names(Reanalysis_data_22_with_MALR))
CTP_22_reanalysis <- data.frame(Dates = dates_22,
                     CTP = CTP_22_list_reanalysis)
### 2023 ###
CTP_23_list_reanalysis <- c()
for(list in as.list(enumerate(Reanalysis_data_23_with_MALR))){
  critical_region <- list$value%>%
    filter(air_pressure < 900, air_pressure > 700)%>%
    mutate(MALR_crit = air_temperature[1] + (MALR/1000) * (geopotential_height - geopotential_height[1]))
 
   CTP <- calculate_CTP(critical_region$air_temperature, critical_region$geopotential_height, critical_region$MALR, critical_region$air_pressure)
  CTP_23_list_reanalysis <- append(CTP_23_list_reanalysis, CTP)
  
}

dates_23 <- ymd_hms(names(Reanalysis_data_23_with_MALR))
CTP_23_reanalysis <- data.frame(Dates = dates_23,
                           CTP = CTP_23_list_reanalysis)
```

### Calculate HI_low

```{r}
### 2021 ### 

# Extracting data at correct pressure levels
data_950 <- data.frame()
data_850 <- data.frame()

for (list in Reanalysis_data_21_with_MALR){
  row_950 <- list[which.min(abs(950-list$air_pressure))]
  data_950 <- rbind(data_950, row_950)
  row_850 <- list[which.min(abs(850-list$air_pressure))]
  data_850 <- rbind(data_850, row_850)
}
# calculating dew point depressions
data_950_dd <- data_950%>%
  mutate(dew_point_depression950 = air_temperature - dew_point_temperature, dateTime = ymd_hms(names(Reanalysis_data_21_with_MALR)))
data_850_dd <- data_850%>%
  mutate(dew_point_depression850 = air_temperature - dew_point_temperature, dateTime = ymd_hms(names(Reanalysis_data_21_with_MALR)))

# calculating HI_low for each sounding and saving the values in a data.frame
HI_low_21_reanalysis <-data.frame(dateTime = ymd_hms(names(Reanalysis_data_21_with_MALR)) , HI_low =  data_850_dd$dew_point_depression850 + data_950_dd$dew_point_depression950)

## 2022 ##

# extracting data from correct pressure levels
data_950 <- data.frame()
data_850 <- data.frame()

for (list in Reanalysis_data_22_with_MALR){
  row_950 <- list[which.min(abs(950-list$air_pressure))]
  data_950 <- rbind(data_950, row_950)
  row_850 <- list[which.min(abs(850-list$air_pressure))]
  data_850 <- rbind(data_850, row_850)
}

# calculating dew point depressions
data_950_dd <- data_950%>%
  mutate(dew_point_depression950 = air_temperature - dew_point_temperature, dateTime = ymd_hms(names(Reanalysis_data_22_with_MALR)))
data_850_dd <- data_850%>%
  mutate(dew_point_depression850 = air_temperature - dew_point_temperature, dateTime = ymd_hms(names(Reanalysis_data_22_with_MALR)))

# calculating HI_low for each sounding and saving the values in a data.frame
HI_low_22_reanalysis <-data.frame(dateTime = ymd_hms(names(Reanalysis_data_22_with_MALR)) , HI_low =  data_850_dd$dew_point_depression850 + data_950_dd$dew_point_depression950)

## 2023 ##

# extracting data from correct pressure levels
data_950 <- data.frame()
data_850 <- data.frame()

for (list in Reanalysis_data_23_with_MALR){
  row_950 <- list[which.min(abs(950-list$air_pressure))]
  data_950 <- rbind(data_950, row_950)
  row_850 <- list[which.min(abs(850-list$air_pressure))]
  data_850 <- rbind(data_850, row_850)
}
# calculating dew point depressions
data_950_dd <- data_950%>%
  mutate(dew_point_depression950 = air_temperature - dew_point_temperature, 
         dateTime = ymd_hms(names(Reanalysis_data_23_with_MALR)))
data_850_dd <- data_850%>%
  mutate(dew_point_depression850 = air_temperature - dew_point_temperature, 
         dateTime = ymd_hms(names(Reanalysis_data_23_with_MALR)))

# calculating HI_low for each sounding and saving the values in a data.frame
HI_low_23_reanalysis <-data.frame(dateTime = ymd_hms(names(Reanalysis_data_23_with_MALR)) , HI_low =  data_850_dd$dew_point_depression850 + data_950_dd$dew_point_depression950)
```


## Plotting the results from HI_low and CTP

```{r}

# creating data frames with both HI_low and CTP for each sounding
CTP_HI_low_21_reanalysis <- data.frame(DateTime = CTP_21_reanalysis$Dates,
                            CTP = CTP_21_reanalysis$CTP,
                            HI_low = HI_low_21_reanalysis$HI_low)
CTP_HI_low_22_reanalysis <- data.frame(DateTime = CTP_22_reanalysis$Dates,
                            CTP = CTP_22_reanalysis$CTP,
                            HI_low = HI_low_22_reanalysis$HI_low)
CTP_HI_low_23_reanalysis <- data.frame(DateTime = CTP_23_reanalysis$Dates,
                            CTP = CTP_23_reanalysis$CTP,
                            HI_low = HI_low_23_reanalysis$HI_low)

CTP_HI_low_tot_reanalysis <- rbind(CTP_HI_low_21_reanalysis,CTP_HI_low_22_reanalysis,CTP_HI_low_23_reanalysis)
options(repr.plot.width=15, repr.plot.height=15)

CTP_HI_low_tot_reanalysis.fig <- ggplot(data = CTP_HI_low_tot_reanalysis, aes(x=CTP, y = HI_low))+
  geom_point()+
  geom_hline(aes(yintercept= 15), color='red', alpha =0.7)+
  geom_hline(aes(yintercept= 5), color= 'blue',alpha = 0.7)+
  geom_vline(aes(xintercept = 0), color = 'black', alpha = 0.7)+
  geom_vline(aes(xintercept = 250), color = 'black', alpha = 0.7)+
  scale_y_continuous(limits = c(0,45), n.breaks = 9)+
  scale_x_continuous(limits = c(-500,1200), n.breaks = 9)+
  theme(legend.text = element_text(size= 14),
        legend.title = element_text(size=16),
        axis.title = element_text(size = 16),
        axis.text = element_text(size =14),
        plot.title = element_text(size = 18))+
  labs(title = 'CTP vs HI_low 2021-2023 reanalysis')+
  xlab("CTP [J/kg]")+ ylab("HI_low [K]")

CTP_HI_low_tot_reanalysis.fig
```


# Classification of days

Classification and identification of precipitative and non precipitative events.

Using only reanalysis data, the amount of convective and stratiform precipitation is made into variables along with total precipitation. Soil moisture and heat fluxes from ERA5 are also used in respective variables

1.  SM_Morning, containing information about the mean soil moisture levels in the morning hoursbefore noon, 12:00. From ERA5.
2.  Convective_precipitation, containing information on the total amount of convective precipitation on the particular day.From ERA5.
3.  Stratiform_precipitation, containing information about the total amount of stratiform precipitation. From ERA5.
4.  BR_Morning, Containing info about bowen ratio, Could be classified as LE dominant, neutral, or H dominant as a factor. From ERA5.
5.  Total_precipitation, information about the sum of stratiform and convective precipitation total amount of the day. From ERA5.
6.  Include CAPE from ERA5.

```{r}
# Importing surface condition and precipitation datasets

Reanalysis_21_EC <- read.csv("Reanalysis_data/reanalysis_21_EC.csv")
Reanalysis_22_EC <- read.csv("Reanalysis_data/reanalysis_22_EC.csv")
Reanalysis_23_EC <- read.csv("Reanalysis_data/reanalysis_23_EC.csv")

Reanalysis_21_precip <- read.csv("Reanalysis_data/reanalysis_21_precip.csv")
Reanalysis_22_precip <- read.csv("Reanalysis_data/reanalysis_22_precip.csv")
Reanalysis_23_precip <- read.csv("Reanalysis_data/reanalysis_23_precip.csv")

# 1. SM from reanalysis data

SM_Morning_21 <- Reanalysis_21_EC%>%
  filter(hour(DateTime)<12)%>%
  group_by(date(DateTime))%>%
  summarise(SM_morning = mean(SM)*100)
colnames(SM_Morning_21) <- c('DateTime', 'SM_morning')

SM_Morning_22 <- Reanalysis_22_EC%>%
  filter(hour(DateTime)<12)%>%
  group_by(date(DateTime))%>%
  summarise(SM_morning = mean(SM)*100)
colnames(SM_Morning_22) <- c('DateTime', 'SM_morning')

SM_Morning_23 <- Reanalysis_23_EC%>%
  filter(hour(DateTime)<12)%>%
  group_by(date(DateTime))%>%
  summarise(SM_morning = mean(SM)*100)
colnames(SM_Morning_23) <- c('DateTime', 'SM_morning')

SM_Morning_tot <- rbind(SM_Morning_21, SM_Morning_22, SM_Morning_23)



# 2,3,5. Precip_reanalysis

Precip_reanalysis_21 <- Reanalysis_21_precip %>%
  mutate(CP = CP*1000, TP = TP*1000)%>%
  group_by(date(DateTime))%>%
  summarise(Conv_precip = sum(CP), Stratiform_precip = sum(TP-CP), Total_precip = sum(TP))
colnames(Precip_reanalysis_21) <- c("DateTime", "Conv_precip", "Stratiform_precip","Total_precip")

Precip_reanalysis_22 <- Reanalysis_22_precip %>%
  mutate(CP = CP*1000, TP = TP*1000)%>%
  group_by(date(DateTime))%>%
  summarise(Conv_precip = sum(CP), Stratiform_precip = sum(TP-CP), Total_precip = sum(TP))
colnames(Precip_reanalysis_22) <- c("DateTime", "Conv_precip", "Stratiform_precip","Total_precip")

Precip_reanalysis_23 <- Reanalysis_23_precip%>%
  mutate(CP = CP*1000, TP = TP*1000)%>%
  group_by(date(DateTime))%>%
  summarise(Conv_precip = sum(CP), Stratiform_precip = sum(TP-CP), Total_precip = sum(TP))
colnames(Precip_reanalysis_23) <- c("DateTime", "Conv_precip", "Stratiform_precip","Total_precip")

Precip_reanalysis_tot <- rbind(Precip_reanalysis_21, Precip_reanalysis_22, Precip_reanalysis_23)


# Morning and evening partitioning of precipitation 

Precip_Morning_21 <- Reanalysis_21_precip%>%
  mutate(CP =CP*1000, TP=TP*1000)%>%
  filter(hour(DateTime)<12)%>%
  group_by(date(DateTime))%>%
    summarise(Conv_precip_M = sum(CP), Stratiform_precip_M = sum(TP-CP), Total_precip_M = sum(TP))
colnames(Precip_Morning_21) <- c("DateTime", "Conv_precip_M", "Stratiform_precip_M","Total_precip_M")

Precip_Morning_22 <- Reanalysis_22_precip%>%
  mutate(CP =CP*1000, TP=TP*1000)%>%
  filter(hour(DateTime)<12)%>%
  group_by(date(DateTime))%>%
    summarise(Conv_precip_M = sum(CP), Stratiform_precip_M = sum(TP-CP), Total_precip_M = sum(TP))
colnames(Precip_Morning_22) <- c("DateTime", "Conv_precip_M", "Stratiform_precip_M","Total_precip_M")

Precip_Morning_23 <- Reanalysis_23_precip%>%
  mutate(CP =CP*1000, TP=TP*1000)%>%
  filter(hour(DateTime)<12)%>%
  group_by(date(DateTime))%>%
    summarise(Conv_precip_M = sum(CP), Stratiform_precip_M = sum(TP-CP), Total_precip_M = sum(TP))
colnames(Precip_Morning_23) <- c("DateTime", "Conv_precip_M", "Stratiform_precip_M","Total_precip_M")

Precip_Morning_tot <- rbind(Precip_Morning_21, Precip_Morning_22, Precip_Morning_23)


Precip_Evening_21 <- Reanalysis_21_precip%>%
  mutate(CP =CP*1000, TP=TP*1000)%>%
  filter(hour(ymd_hms(DateTime))>12)%>%
  group_by(date(DateTime))%>%
    summarise(Conv_precip_E = sum(CP), Stratiform_precip_E = sum(TP-CP), Total_precip_E = sum(TP))
colnames(Precip_Evening_21) <- c("DateTime", "Conv_precip_E", "Stratiform_precip_E","Total_precip_E")

Precip_Evening_22 <- Reanalysis_22_precip%>%
  mutate(CP =CP*1000, TP=TP*1000)%>%
  filter(hour(ymd_hms(DateTime))>12)%>%
  group_by(date(DateTime))%>%
    summarise(Conv_precip_E = sum(CP), Stratiform_precip_E = sum(TP-CP), Total_precip_E = sum(TP))
colnames(Precip_Evening_22) <- c("DateTime", "Conv_precip_E", "Stratiform_precip_E","Total_precip_E")

Precip_Evening_23 <- Reanalysis_23_precip%>%
  mutate(CP =CP*1000, TP=TP*1000)%>%
  filter(hour(ymd_hms(DateTime))>12)%>%
  group_by(date(DateTime))%>%
    summarise(Conv_precip_E = sum(CP), Stratiform_precip_E = sum(TP-CP), Total_precip_E = sum(TP))
colnames(Precip_Evening_23) <- c("DateTime", "Conv_precip_E", "Stratiform_precip_E","Total_precip_E")

Precip_Evening_tot <- rbind(Precip_Evening_21, Precip_Evening_22, Precip_Evening_23)


# 4. BR from reanalysis data 

BR_Morning_21 <- Reanalysis_21_EC %>%
  filter(hour(DateTime)<12)%>%
  group_by(date(DateTime))%>%
  summarise(BR_Morning = mean((SH)/(LE)))
colnames(BR_Morning_21) <- c("DateTime", "BR_Morning")

BR_Morning_22 <- Reanalysis_22_EC %>%
  filter(hour(DateTime)<12)%>%
  group_by(date(DateTime))%>%
  summarise(BR_Morning = mean(SH/LE))
colnames(BR_Morning_22) <- c("DateTime", "BR_Morning")

BR_Morning_23 <- Reanalysis_23_EC %>%
  filter(hour(DateTime)<12)%>%
  group_by(date(DateTime))%>%
  summarise(BR_Morning = mean(SH/LE))
colnames(BR_Morning_23) <- c("DateTime", "BR_Morning")

BR_Morning_tot <- rbind(BR_Morning_21, BR_Morning_22, BR_Morning_23)



# 6. Including CAPE and CIN from Reanalysis data

Reanalysis_21_indices <- read.csv('Reanalysis_data/reanalysis_21_indices.csv')
Reanalysis_22_indices <- read.csv('Reanalysis_data/reanalysis_22_indices.csv')
Reanalysis_23_indices <- read.csv('Reanalysis_data/reanalysis_23_indices.csv')

Reanalysis_indices_combined <- rbind(Reanalysis_21_indices, Reanalysis_22_indices, Reanalysis_23_indices)

Reanalysis_indices_filtered <- Reanalysis_indices_combined%>%
  group_by(date(DateTime))%>%
  mutate(DateTime = date(DateTime), CAPE = max(CAPE), CIN = max(CIN))%>%
  distinct(DateTime, .keep_all = T)


# Combining with CTP_HI_low values 

CTP_HI_low_extended_reanalysis <- data.frame(DateTime = CTP_HI_low_tot_reanalysis$DateTime,
                                  CTP = CTP_HI_low_tot_reanalysis$CTP,
                                  HI_low = CTP_HI_low_tot_reanalysis$HI_low,
                                  CAPE = Reanalysis_indices_filtered$CAPE,
                                  SM_Morning = SM_Morning_tot$SM_morning,
                                  BR_Morning = BR_Morning_tot$BR_Morning,
                                  Conv_Precip = Precip_reanalysis_tot$Conv_precip,
                                  Stratiform_precip = Precip_reanalysis_tot$Stratiform_precip,
                                  Total_precip = Precip_reanalysis_tot$Total_precip,
                                  Conv_precip_E = Precip_Evening_tot$Conv_precip_E,
                                  Stratiform_precip_E = Precip_Evening_tot$Stratiform_precip_E,
                                  Total_precip_E = Precip_Evening_tot$Total_precip_E,
                                  Conv_precip_M = Precip_Morning_tot$Conv_precip_M,
                                  stratiform_precip_M = Precip_Morning_tot$Stratiform_precip_M,
                                  Total_precip_M = Precip_Morning_tot$Total_precip_M) 

# Checking for NAs

count_na <- colSums(sapply(CTP_HI_low_extended_reanalysis, is.na))
count_na

# Calculating correlations
correlations<- round(cor(CTP_HI_low_extended_reanalysis[,c(2,3,4,5,6,7,8,9)]), 1)

corrplot.fig <- ggcorrplot(correlations, lab = T)
corrplot.fig
summary(CTP_HI_low_extended_reanalysis)

CTP_density.fig <- ggplot(CTP_HI_low_extended_reanalysis, aes(x = CTP)) + 
  geom_histogram(aes(y = ..density..),
                 colour = 1, fill = "white") +
  geom_density(colour = "#0072B2", lwd = 1.2)+
  labs(x= "CTP [J/kg]")
HI_low_density.fig <- ggplot(CTP_HI_low_extended_reanalysis, aes(x = HI_low)) + 
  geom_histogram(aes(y = ..density..),
                 colour = 1, fill = "white") +
  geom_density(colour = "#0072B2", lwd = 1.2)+
  labs(x=expression(paste(HI[low],  " [K]")))
```

### Setting the limits for each class of the different variables 
```{r}
# setting the 3 of the new variables as categorical factors

CTP_HI_low_extended_reanalysis$SM_Morning_cat <- cut(CTP_HI_low_extended_reanalysis$SM_Morning,
                                          breaks = c(0,25,100),
                                          labels = c("low", "high"))

CTP_HI_low_extended_reanalysis$BR_Morning_cat <- cut(CTP_HI_low_extended_reanalysis$BR_Morning,
                                                     breaks = c(-2,0.5,Inf),
                                                     labels = c("low", "high"))
CTP_HI_low_extended_reanalysis$Total_precip_M_cat <- cut(CTP_HI_low_extended_reanalysis$Total_precip_M,
                                                     breaks = c(-1,1,Inf),
                                                     labels = c("No rain", "Rain"))
CTP_HI_low_extended_reanalysis$Total_precip_E_cat <- cut(CTP_HI_low_extended_reanalysis$Total_precip_E,
                                                     breaks = c(-1,1,Inf),
                                                     labels = c("No rain", "Rain"))
```


```{r}
# Creating a binary classifier of convection or not, modelled convective precipitation above 1 mm classifies as convective.
Reanalysis_classified <- CTP_HI_low_extended_reanalysis %>%
  rowwise()%>%
  mutate( conv = {
    case_when((Conv_Precip>1)~1,
              (Conv_Precip <1)~0)})%>%
  mutate(conv = as.factor(conv))
summary(Reanalysis_classified)


## Classify based on convective and stratiform precipitation from ERA5
# Plot correlation plot of stratiform and convective precipitations

precip_corr_fig <- ggplot(data = CTP_HI_low_extended_reanalysis)+
  geom_point(aes(x= Stratiform_precip, y = Conv_Precip))

precip_corr_fig

# make a new variable which shows the relationship between stratiform and convective precipitation, and which precipitation type is the dominant one.
CTP_HI_low_extended_reanalysis<- CTP_HI_low_extended_reanalysis%>%
  mutate(Precip_type = Conv_Precip-Stratiform_precip)
#Convective if the value of precip_type>=1, Stratiform if value of precip_type<=-1, non/neither if -1<precip_type<1

CTP_HI_low_extended_reanalysis$Precip_type_cat <- cut(CTP_HI_low_extended_reanalysis$Precip_type,
                                          breaks = c(-Inf,-1,1,Inf),
                                          labels = c("Stratiform", "non/neither", "Convective"))

summary(CTP_HI_low_extended_reanalysis)
```


```{r}

# Plot of precipitation type and soil moisture 
Convective_classified_reanalysis_SM.fig <- ggplot(data = CTP_HI_low_extended_reanalysis, aes(x = CTP, y = HI_low))+
  geom_point(aes(col = Precip_type_cat, shape = SM_Morning_cat ), stroke = 1.5)+
  geom_hline(yintercept= 15,linetype = "dashed", color='red')+
  geom_hline(yintercept= 10,linetype = "dashed", color='gray')+
  geom_hline(yintercept = 5,linetype = "dashed", color= 'blue')+
  geom_vline(xintercept = 0, linetype = "dashed", color = "black")+
  geom_vline(xintercept = 250, linetype = "dashed", color = "black")+
  scale_shape_manual(values=c(4, 16))+
  scale_color_manual(values = c( "#0072B2", "#D55E00", "#009E73"))+
  #scale_size_manual(values = c(2, 5))+
  scale_x_continuous(limits = c(-500, 1200), n.breaks = 8)+
  scale_y_continuous(limits = c(-1,45), n.breaks = 9)+
  theme(legend.text = element_text(size = 14), 
        legend.title = element_text(size = 16), 
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 16),
        plot.title = element_text(size = 18))+  
  labs( color = "Precipitation type", shape= "Soil moisture")+
  xlab("CTP [J/kg]")+ylab(expression(paste(HI[low],  " [K]")))
Convective_classified_reanalysis_SM.fig


# Plot of July and August 2023
Reanalysis_2023_July_August <- CTP_HI_low_extended_reanalysis%>%
  filter(year(DateTime) == 2023 ,month(DateTime)>06, month(DateTime)<09)

Reanalysis_2023_July_August.fig <- ggplot(data =Reanalysis_2023_July_August, aes(x = CTP, y = HI_low))+
  geom_point(aes(col = Precip_type_cat, shape = SM_Morning_cat ), stroke = 1.5)+
  geom_hline(yintercept= 15,linetype = "dashed", color='red')+
  geom_hline(yintercept= 10,linetype = "dashed", color='gray')+
  geom_hline(yintercept = 5,linetype = "dashed", color= 'blue')+
  geom_vline(xintercept = 0, linetype = "dashed", color = "black")+
  geom_vline(xintercept = 250, linetype = "dashed", color = "black")+
  scale_shape_manual(values=c(3, 16))+
  scale_color_manual(values = c( "#0072B2", "#D55E00", "#009E73"))+
  scale_x_continuous(limits = c(-500, 1200), n.breaks = 8)+
  scale_y_continuous(limits = c(0, 45), n.breaks = 9)+
  theme(legend.text = element_text(size = 14), 
        legend.title = element_text(size = 16), 
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 16),
        plot.title = element_text(size = 18))+  
  labs(color = "Precipitation type", shape= "Soil moisture")+ 
  xlab("CTP [J/kg]")+ylab(expression(paste(HI[low],  " [K]")))
Reanalysis_2023_July_August.fig

# Plot of only positive convective events
Reanalysis_positive_conv <- CTP_HI_low_extended_reanalysis %>%
  filter(Conv_Precip>1)

Convective_reanalysis.fig <- ggplot(data = Reanalysis_positive_conv, aes(x = CTP, y = HI_low))+
  geom_point(aes(col = Precip_type_cat, shape = SM_Morning_cat ), stroke = 1.5)+
  geom_hline(yintercept= 15,linetype = "dashed", color='red')+
  geom_hline(yintercept= 10,linetype = "dashed", color='gray')+
  geom_hline(yintercept = 5,linetype = "dashed", color= 'blue')+
  scale_shape_manual(values=c(4, 16))+
  scale_color_manual(values = c("#0072B2","#D55E00", "#009E73"))+
  #scale_size_manual(values = c(2, 5))+
  scale_x_continuous(limits = c(-500, 1200), n.breaks = 8)+
  scale_y_continuous(limits = c(-1,45), n.breaks = 9)+
  #stat_ellipse(aes(col = NB_Morning), geom = 'polygon', alpha =0.2)+
  theme(legend.text = element_text(size = 14), 
        legend.title = element_text(size = 16), 
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 16),
        plot.title = element_text(size = 18))+  
  labs(color = "Precipitation type", shape= "Soil moisture")+ 
  xlab("CTP [J/kg]")+ylab(expression(paste(HI[low],  " [K]")))
Convective_reanalysis.fig

```


### Creating a plot similar to the one in the sounding data

```{r}

sounding_dates_reanalysis <- filter(CTP_HI_low_extended_reanalysis, date(DateTime) %in% date(CTP_HI_low_tot$DateTime))

Convective_SM.fig <- ggplot(data = sounding_dates_reanalysis, aes(x = CTP, y = HI_low))+
  geom_point(aes(col = Total_precip_M_cat, shape = Total_precip_E_cat, size = SM_Morning_cat ), stroke = 1.5)+
  geom_hline(yintercept= 15,linetype = "dashed", color='red')+
  geom_hline(yintercept= 10,linetype = "dashed", color='gray')+
  geom_hline(yintercept = 5,linetype = "dashed", color= 'blue')+
  geom_vline(xintercept = 0, linetype = "dashed", color = "black")+
  geom_vline(xintercept = 250, linetype = "dashed", color = "black")+
  scale_shape_manual(values = c(4, 16))+
  scale_color_manual(values = c("#D55E00", "#0072B2"))+
  scale_size_manual(values = c(2, 5))+
  scale_x_continuous(limits = c(-500, 1200), n.breaks = 10)+
  scale_y_continuous(limits = c(-1,45), n.breaks = 9)+
  #stat_ellipse(aes(col = NB_Morning), geom = 'polygon', alpha =0.2)+
  theme(legend.text = element_text(size = 14), 
        legend.title = element_text(size = 16), 
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 16),
        plot.title = element_text(size = 18))+  
  labs( color = "Morning Precipitation", shape= "Evening Precipitation", size = "Soil Moisture")+
  xlab("CTP [J/kg]")+ylab("HI_low [K]")
Convective_SM.fig

```




















